<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0f172a" />
  <title>Presupuesto + Avance mensual (offline)</title>

  <!-- Carga XLSX: 1) local ./xlsx.full.min.js (offline)  2) fallback CDN -->
  <script>
    (function () {
      const LOCAL = "./xlsx.full.min.js";
      const CDN   = "https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js";

      function load(src, onok, onerr){
        const s = document.createElement("script");
        s.src = src;
        s.async = true;
        s.onload = onok;
        s.onerror = onerr;
        document.head.appendChild(s);
      }

      load(LOCAL,
        () => { window.__XLSX_SRC = "local"; },
        () => load(CDN,
          () => { window.__XLSX_SRC = "cdn"; },
          () => { window.__XLSX_SRC = "fail"; }
        )
      );
    })();
  </script>

  <style>
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    body{margin:0;padding:18px;background:#0b1220;color:#e5e7eb}
    h1{margin:0 0 14px;text-align:center;font-size:1.1rem}
    .card{
      max-width:1100px;margin:0 auto 14px;
      background:#050a14;border:1px solid #1f2937;border-radius:16px;
      padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.35)
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    label{font-size:.8rem;color:#9ca3af;display:block;margin-bottom:4px}
    input[type="file"], select, input[type="text"]{
      width:100%;padding:10px;border-radius:12px;border:1px solid #334155;
      background:#0b1220;color:#e5e7eb;font-size:.95rem
    }
    .btn{
      border:0;border-radius:999px;padding:10px 14px;font-weight:800;cursor:pointer;
      display:inline-flex;align-items:center;gap:8px;font-size:.92rem;
      user-select:none;-webkit-user-select:none;touch-action:manipulation;
    }
    .btn-primary{background:linear-gradient(90deg,#22d3ee,#a855f7);color:#050a14}
    .btn-success{background:linear-gradient(90deg,#22c55e,#a3e635);color:#052e1a}
    .btn-secondary{background:#0b1220;color:#e5e7eb;border:1px solid #334155}
    .btn-disabled{opacity:.45;cursor:not-allowed}
    .pill{font-size:.72rem;letter-spacing:.08em;text-transform:uppercase;
      padding:4px 10px;border-radius:999px;background:rgba(148,163,184,.18);
      border:1px solid rgba(203,213,225,.18);color:#cbd5e1;font-weight:900
    }
    .ok{color:#34d399}
    .warn{color:#fbbf24}
    .err{color:#fb7185}
    .muted{color:#9ca3af;font-size:.85rem}
    .grid{
      display:grid;gap:10px;
      grid-template-columns:repeat(3, minmax(0,1fr));
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:repeat(2, minmax(0,1fr));}
    }
    @media (max-width: 640px){
      .grid{grid-template-columns:1fr;}
    }
    .tableWrap{
      margin-top:12px; overflow:auto; max-height:65vh;
      border:1px solid #1f2937;border-radius:14px;background:#0b1220
    }
    table{border-collapse:collapse;width:100%;min-width:980px}
    th,td{border:1px solid #1f2937;padding:8px 10px;font-size:.9rem;vertical-align:top}
    th{position:sticky;top:0;background:rgba(5,10,20,.92);backdrop-filter:blur(6px);z-index:2}
    tr.chapter td{
      background:rgba(34,211,153,.10);
      font-weight:900;
      color:#d1fae5;
    }
    .kpi{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .kpi span{padding:6px 10px;border:1px solid rgba(203,213,225,.18);border-radius:999px;background:rgba(148,163,184,.10)}
  </style>
</head>

<body>
  <h1>Presupuesto + Avance mensual (offline)</h1>

  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <div class="row">
        <span class="pill">excel</span>
        <div class="muted">Sin internet funciona si subes <b>xlsx.full.min.js</b> al repo.</div>
      </div>
      <div id="status" class="muted"></div>
    </div>

    <div class="row" style="margin-top:12px;">
      <div style="flex:1;min-width:260px">
        <label>Archivo Excel</label>
        <input id="file" type="file" accept=".xlsx,.xlsm,.xls" />
        <div class="muted" id="fileHint">Tip: primero elige el archivo, luego selecciona la hoja.</div>
      </div>

      <div style="flex:1;min-width:260px">
        <label>Hoja</label>
        <select id="sheet" disabled>
          <option value="">‚Äî primero carga un archivo ‚Äî</option>
        </select>
      </div>

      <div style="min-width:210px">
        <label>&nbsp;</label>
        <button class="btn btn-success btn-disabled" id="btnLoadSheet" disabled>üì• Cargar hoja</button>
      </div>
    </div>

    <div class="kpi" id="kpi"></div>

    <div class="grid" style="margin-top:12px;">
      <div>
        <label>Columna C√≥digo (opcional)</label>
        <select id="colCode" disabled><option value="">‚Äî (opcional) ‚Äî</option></select>
      </div>
      <div>
        <label>Columna Descripci√≥n</label>
        <select id="colDesc" disabled><option value="">‚Äî seleccionar ‚Äî</option></select>
      </div>
      <div>
        <label>Columna Cant. Contrato</label>
        <select id="colQty" disabled><option value="">‚Äî seleccionar ‚Äî</option></select>
      </div>
      <div>
        <label>Columna Unidad (opcional)</label>
        <select id="colUnit" disabled><option value="">‚Äî (opcional) ‚Äî</option></select>
      </div>
      <div>
        <label>Columna Vr. Unitario (opcional)</label>
        <select id="colVU" disabled><option value="">‚Äî (opcional) ‚Äî</option></select>
      </div>
      <div>
        <label>&nbsp;</label>
        <button class="btn btn-primary btn-disabled" id="btnBuild" disabled>üß± Construir tabla</button>
      </div>
    </div>

    <div class="tableWrap" id="tableWrap" style="display:none"></div>
  </div>

<script>
  const $ = (id)=>document.getElementById(id);

  const statusEl = $("status");
  const kpiEl = $("kpi");

  const fileInput = $("file");
  const sheetSel = $("sheet");
  const btnLoadSheet = $("btnLoadSheet");
  const btnBuild = $("btnBuild");

  const colCode = $("colCode");
  const colDesc = $("colDesc");
  const colQty  = $("colQty");
  const colUnit = $("colUnit");
  const colVU   = $("colVU");

  const tableWrap = $("tableWrap");

  let wb = null;
  let activeSheetName = "";
  let sheetData = null;          // 2D array
  let headerRowIndex = null;     // number
  let headers = [];              // string[]
  let records = [];              // parsed rows

  function setStatus(msg, kind="muted"){
    const cls = kind==="ok" ? "ok" : kind==="warn" ? "warn" : kind==="err" ? "err" : "muted";
    statusEl.className = cls;
    statusEl.textContent = msg;
  }

  function setBtn(btn, enabled){
    btn.disabled = !enabled;
    btn.classList.toggle("btn-disabled", !enabled);
  }

  function setSelectEnabled(sel, enabled){
    sel.disabled = !enabled;
  }

  function clearSelect(sel, placeholderText){
    sel.innerHTML = "";
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = placeholderText;
    sel.appendChild(opt);
  }

  function addOptions(sel, arr){
    arr.forEach((label, idx) => {
      const o = document.createElement("option");
      o.value = String(idx);
      o.textContent = label;
      sel.appendChild(o);
    });
  }

  function countNonEmpty(row){
    let c = 0;
    for (const v of row){
      if (v !== null && v !== undefined && String(v).trim() !== "") c++;
    }
    return c;
  }

  function detectHeaderRow(data2d, maxScan=60){
    let bestIdx = null;
    let bestCount = 0;

    const limit = Math.min(maxScan, data2d.length);
    for (let i=0;i<limit;i++){
      const row = data2d[i] || [];
      const c = countNonEmpty(row);
      if (c > bestCount){
        bestCount = c;
        bestIdx = i;
      }
    }
    // m√≠nimo razonable: 4 columnas con texto/valores
    if (bestIdx === null || bestCount < 4) return { idx:null, count:bestCount };
    return { idx:bestIdx, count:bestCount };
  }

  function normalizeHeaders(row){
    const out = [];
    const seen = new Map();
    const maxLen = row.length;

    for (let i=0;i<maxLen;i++){
      let h = (row[i] ?? "").toString().trim();
      if (!h) h = `Col ${i+1}`;

      // Evitar duplicados (muy com√∫n por celdas combinadas)
      const key = h.toLowerCase();
      const n = (seen.get(key) || 0) + 1;
      seen.set(key, n);
      if (n > 1) h = `${h} (${n})`;

      out.push(h);
    }

    // Recortar ‚Äúcolas‚Äù vac√≠as
    while (out.length && /^Col \d+$/.test(out[out.length-1]) && out[out.length-1].startsWith("Col ")){
      // solo si en la fila original estaba vac√≠o
      // (si era real, no lo borraremos; pero aqu√≠ asumimos col vac√≠a al final)
      out.pop();
    }

    return out;
  }

  function isProbablyChapter(code, desc, unit, qty){
    const c = (code || "").trim();
    const d = (desc || "").trim();

    // t√≠picos: "1." , "1.1" , "1.1.1"
    const codeLooks = c && /^[0-9]+(\.[0-9]+)*\.?$/.test(c);

    // si no tiene unidad y cantidad, suele ser cap√≠tulo/subcap√≠tulo
    const noNumbers = (qty==="" || qty===null || qty===undefined) && (unit==="" || unit==null);
    const descLooks = d && d === d.toUpperCase() && d.length >= 4;

    return (codeLooks && (descLooks || noNumbers));
  }

  function waitForXLSX(){
    return new Promise((resolve) => {
      const t0 = Date.now();
      const tick = () => {
        if (window.XLSX){
          resolve(true);
          return;
        }
        if (Date.now() - t0 > 9000){
          resolve(false);
          return;
        }
        setTimeout(tick, 80);
      };
      tick();
    });
  }

  function kpiRender(obj){
    kpiEl.innerHTML = "";
    const add = (txt) => {
      const s = document.createElement("span");
      s.textContent = txt;
      kpiEl.appendChild(s);
    };
    if (!obj) return;
    if (obj.src) add(`XLSX: ${obj.src}`);
    if (obj.sheet) add(`Hoja: ${obj.sheet}`);
    if (obj.headerRow != null) add(`Encabezado: fila ${obj.headerRow+1}`);
    if (obj.cols != null) add(`Columnas: ${obj.cols}`);
    if (obj.rows != null) add(`Filas data: ${obj.rows}`);
  }

  async function init(){
    const ok = await waitForXLSX();
    if (!ok){
      setStatus("No carg√≥ XLSX. Sube xlsx.full.min.js al repo o usa internet.", "err");
      return;
    }
    setStatus(`Listo. XLSX carg√≥ (${window.__XLSX_SRC || "?"}).`, "ok");
    kpiRender({ src: window.__XLSX_SRC || "?" });
  }

  fileInput.addEventListener("change", async () => {
    tableWrap.style.display = "none";
    tableWrap.innerHTML = "";

    wb = null;
    sheetSel.innerHTML = `<option value="">‚Äî cargando... ‚Äî</option>`;
    setSelectEnabled(sheetSel, false);
    setBtn(btnLoadSheet, false);
    setBtn(btnBuild, false);

    clearSelect(colCode, "‚Äî (opcional) ‚Äî");
    clearSelect(colDesc, "‚Äî seleccionar ‚Äî");
    clearSelect(colQty,  "‚Äî seleccionar ‚Äî");
    clearSelect(colUnit, "‚Äî (opcional) ‚Äî");
    clearSelect(colVU,   "‚Äî (opcional) ‚Äî");
    [colCode,colDesc,colQty,colUnit,colVU].forEach(s=>setSelectEnabled(s,false));

    const file = fileInput.files?.[0];
    if (!file){ setStatus("Selecciona un archivo Excel.", "warn"); return; }

    if (!window.XLSX){
      setStatus("XLSX no est√° disponible. Revisa xlsx.full.min.js / internet.", "err");
      return;
    }

    try{
      setStatus("Leyendo archivo...", "muted");
      const ab = await file.arrayBuffer();
      wb = XLSX.read(ab, { type:"array" });

      const names = wb.SheetNames || [];
      if (!names.length){
        setStatus("No encontr√© hojas en ese Excel.", "err");
        return;
      }

      sheetSel.innerHTML = "";
      names.forEach(n=>{
        const o=document.createElement("option");
        o.value=n; o.textContent=n;
        sheetSel.appendChild(o);
      });
      activeSheetName = names[0];
      sheetSel.value = activeSheetName;

      setSelectEnabled(sheetSel, true);
      setBtn(btnLoadSheet, true);

      setStatus("Archivo cargado ‚úÖ Elige hoja y presiona ‚ÄúCargar hoja‚Äù.", "ok");
      kpiRender({ src: window.__XLSX_SRC || "?", sheet: activeSheetName });

    }catch(e){
      console.error(e);
      setStatus("Error leyendo el Excel. ¬øEst√° protegido o da√±ado?", "err");
    }
  });

  sheetSel.addEventListener("change", () => {
    activeSheetName = sheetSel.value || "";
    kpiRender({ src: window.__XLSX_SRC || "?", sheet: activeSheetName });
  });

  btnLoadSheet.addEventListener("click", () => {
    if (!wb){ setStatus("Primero carga un archivo.", "warn"); return; }
    if (!activeSheetName){ setStatus("Selecciona una hoja.", "warn"); return; }

    try{
      setStatus("Cargando hoja...", "muted");
      const ws = wb.Sheets[activeSheetName];
      const data = XLSX.utils.sheet_to_json(ws, { header:1, raw:false, defval:"" });

      if (!data || !data.length){
        setStatus("Esa hoja est√° vac√≠a.", "warn");
        return;
      }

      sheetData = data;

      const found = detectHeaderRow(sheetData, 60);
      if (found.idx == null){
        setStatus("No pude detectar encabezados. Revisa que haya una fila con t√≠tulos de columna.", "err");
        return;
      }

      headerRowIndex = found.idx;
      headers = normalizeHeaders(sheetData[headerRowIndex] || []);
      if (!headers.length){
        setStatus("Detect√© fila de encabezado, pero sin columnas v√°lidas.", "err");
        return;
      }

      // llenar selects
      clearSelect(colCode, "‚Äî (opcional) ‚Äî");
      clearSelect(colDesc, "‚Äî seleccionar ‚Äî");
      clearSelect(colQty,  "‚Äî seleccionar ‚Äî");
      clearSelect(colUnit, "‚Äî (opcional) ‚Äî");
      clearSelect(colVU,   "‚Äî (opcional) ‚Äî");

      addOptions(colCode, headers);
      addOptions(colDesc, headers);
      addOptions(colQty,  headers);
      addOptions(colUnit, headers);
      addOptions(colVU,   headers);

      [colCode,colDesc,colQty,colUnit,colVU].forEach(s=>setSelectEnabled(s,true));
      setBtn(btnBuild, true);

      // Heur√≠stica r√°pida de autoselecci√≥n por nombre
      function autoPick(sel, patterns){
        for (let i=0;i<headers.length;i++){
          const h = headers[i].toLowerCase();
          if (patterns.some(p => h.includes(p))) { sel.value = String(i); return true; }
        }
        return false;
      }

      autoPick(colDesc, ["descrip"]);
      autoPick(colQty,  ["cant", "cantidad"]);
      autoPick(colCode, ["item","√≠tem","codigo","c√≥digo"]);
      autoPick(colUnit, ["und","unidad"]);
      autoPick(colVU,   ["unitario","vlr. unit","vr. unit","valor unit"]);

      const dataRows = Math.max(0, sheetData.length - (headerRowIndex+1));
      kpiRender({ src: window.__XLSX_SRC || "?", sheet: activeSheetName, headerRow: headerRowIndex, cols: headers.length, rows: dataRows });

      setStatus(`Hoja lista ‚úÖ Encabezado detectado en fila ${headerRowIndex+1}. Ahora elige columnas y ‚ÄúConstruir tabla‚Äù.`, "ok");

    }catch(e){
      console.error(e);
      setStatus("Error procesando la hoja. Abre la consola para ver detalle.", "err");
    }
  });

  btnBuild.addEventListener("click", () => {
    if (!sheetData || headerRowIndex == null){
      setStatus("Primero ‚ÄúCargar hoja‚Äù.", "warn");
      return;
    }

    const idxDesc = colDesc.value ? Number(colDesc.value) : null;
    const idxQty  = colQty.value  ? Number(colQty.value)  : null;
    const idxCode = colCode.value ? Number(colCode.value) : null;
    const idxUnit = colUnit.value ? Number(colUnit.value) : null;
    const idxVU   = colVU.value   ? Number(colVU.value)   : null;

    if (idxDesc == null || idxQty == null){
      setStatus("Selecciona m√≠nimo: Descripci√≥n y Cant. Contrato.", "warn");
      return;
    }

    const out = [];
    for (let r = headerRowIndex+1; r < sheetData.length; r++){
      const row = sheetData[r] || [];
      const code = idxCode==null ? "" : String(row[idxCode] ?? "").trim();
      const desc = String(row[idxDesc] ?? "").trim();
      const qty  = String(row[idxQty] ?? "").trim();
      const unit = idxUnit==null ? "" : String(row[idxUnit] ?? "").trim();
      const vu   = idxVU==null   ? "" : String(row[idxVU] ?? "").trim();

      // saltar filas totalmente vac√≠as
      const any = [code,desc,qty,unit,vu].some(v => v && v.trim() !== "");
      if (!any) continue;

      const chapter = isProbablyChapter(code, desc, unit, qty);

      out.push({ code, desc, qty, unit, vu, chapter });
    }

    if (!out.length){
      setStatus("No sali√≥ nada. Revisa que las columnas elegidas s√≠ tengan datos.", "warn");
      tableWrap.style.display = "none";
      tableWrap.innerHTML = "";
      return;
    }

    records = out;
    renderTable(records);
    setStatus(`Tabla construida ‚úÖ Filas: ${records.length}`, "ok");
  });

  function renderTable(rows){
    tableWrap.style.display = "block";

    const html = [];
    html.push(`<table>`);
    html.push(`
      <thead>
        <tr>
          <th style="width:120px">C√≥digo</th>
          <th>Descripci√≥n</th>
          <th style="width:110px">Unidad</th>
          <th style="width:140px">Cant. Contrato</th>
          <th style="width:140px">Vr. Unitario</th>
        </tr>
      </thead>
      <tbody>
    `);

    for (const it of rows){
      if (it.chapter){
        html.push(`
          <tr class="chapter">
            <td>${escapeHtml(it.code)}</td>
            <td colspan="4">${escapeHtml(it.desc)}</td>
          </tr>
        `);
      } else {
        html.push(`
          <tr>
            <td>${escapeHtml(it.code)}</td>
            <td>${escapeHtml(it.desc)}</td>
            <td>${escapeHtml(it.unit)}</td>
            <td>${escapeHtml(it.qty)}</td>
            <td>${escapeHtml(it.vu)}</td>
          </tr>
        `);
      }
    }

    html.push(`</tbody></table>`);
    tableWrap.innerHTML = html.join("");
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;");
  }

  init();
</script>
</body>
</html>
